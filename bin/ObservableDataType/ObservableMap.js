"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const ObservableVariable_1 = require("./ObservableVariable");
/**
 * 可观察改变Map
 */
class ObservableMap extends ObservableVariable_1.ObservableVariable {
    constructor(value) {
        super(value);
        //#endregion
        //#region 属性
        this._onAdd = new Set();
        this._onRemove = new Set();
        this._onUpdate = new Set();
        if (this !== value)
            if (Array.isArray(value))
                this._value = new Map(value);
    }
    static observe(value, path) {
        if (path === undefined) {
            return new ObservableMap(value);
        }
        else if ('string' === typeof path) {
            path = path.split('.');
        }
        for (let index = 0, end = path.length - 1; index < end; index++) {
            value = value[path[index]];
        }
        value[path[path.length - 1]] = new ObservableMap(value[path[path.length - 1]]);
    }
    /**
     * Map元素个数
     */
    get size() {
        return this._value.size;
    }
    //#endregion
    //#region toJSON
    toJSON() {
        return this.serializable ? [...this._value] : undefined;
    }
    on(event, callback) {
        switch (event) {
            case 'update':
                this._onUpdate.add(callback);
                break;
            case 'beforeUpdate':
                this._onBeforeUpdate = callback;
                break;
            case 'add':
                this._onAdd.add(callback);
                break;
            case 'remove':
                this._onRemove.add(callback);
                break;
            default:
                super.on(event, callback);
                break;
        }
    }
    once(event, callback) {
        super.once(event, callback);
    }
    off(event, callback) {
        switch (event) {
            case 'update':
                callback ? this._onUpdate.delete(callback) : this._onUpdate.clear();
                break;
            case 'beforeUpdate':
                this._onBeforeUpdate = undefined;
                break;
            case 'add':
                callback ? this._onAdd.delete(callback) : this._onAdd.clear();
                break;
            case 'remove':
                callback ? this._onRemove.delete(callback) : this._onRemove.clear();
                break;
            default:
                super.off(event, callback);
                break;
        }
    }
    //#endregion
    //#region Map修改操作方法
    /**
     * 移除Map对象中的所有元素。
     */
    clear() {
        if (this.readonly)
            throw new Error(`尝试修改一个只读的 ${this.constructor.name}`);
        if (this._onRemove.size > 0) {
            this._value.forEach((value, key) => {
                this._value.delete(key);
                this._onRemove.forEach(callback => callback(value, key));
            });
        }
        else
            this._value.clear();
    }
    /**
     * 用于移除 Map 对象中指定的元素。
     */
    delete(key) {
        if (this.readonly)
            throw new Error(`尝试修改一个只读的 ${this.constructor.name}`);
        if (this._onRemove.size > 0) {
            if (this._value.has(key)) {
                const value = this._value.get(key);
                this._value.delete(key);
                this._onRemove.forEach(callback => callback(value, key));
                return true;
            }
            else
                return false;
        }
        else
            return this._value.delete(key);
    }
    /**
     * 为Map对象添加一个指定键（key）和值（value）的新元素。
     */
    set(key, value) {
        if (this.readonly)
            throw new Error(`尝试修改一个只读的 ${this.constructor.name}`);
        if (this._value.has(key)) {
            const oldValue = this._value.get(key);
            if (this._onBeforeUpdate !== undefined)
                if (this._onBeforeUpdate(key, value, oldValue, this._value) === false)
                    return this;
            this._value.set(key, value);
            this._onUpdate.forEach(callback => callback(value, oldValue, key));
        }
        else {
            this._value.set(key, value);
            this._onAdd.forEach(callback => callback(value, key));
        }
        return this;
    }
    //#endregion
    //#region Map读取操作方法
    /**
     * 返回一个新的包含 [key, value] 对的 Iterator 对象，返回的迭代器的迭代顺序与 Map 对象的插入顺序相同。
     */
    entries() {
        return this._value.entries();
    }
    /**
     * 以插入顺序对 Map 对象中的每一个键值对执行一次参数中提供的回调函数。
     */
    forEach(callbackfn, thisArg) {
        this._value.forEach(callbackfn, thisArg);
    }
    /**
     * 用来获取一个 Map 对象中指定的元素。
     */
    get(key) {
        return this._value.get(key);
    }
    /**
     * 返回一个bool值，用来表明map 中是否存在指定元素
     */
    has(key) {
        return this._value.has(key);
    }
    /**
     * 返回一个新的 Iterator 对象。它包含按照顺序插入Map对象中每个元素的key值。
     */
    keys() {
        return this._value.keys();
    }
    /**
     * 返回一个新的Iterator对象。它包含按顺序插入Map对象中每个元素的value值。
     */
    values() {
        return this._value.values();
    }
}
exports.ObservableMap = ObservableMap;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk9ic2VydmFibGVEYXRhVHlwZS9PYnNlcnZhYmxlTWFwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkRBQTBEO0FBRTFEOztHQUVHO0FBQ0gsbUJBQWlDLFNBQVEsdUNBQTZCO0lBdUNsRSxZQUFZLEtBQThEO1FBQ3RFLEtBQUssQ0FBQyxLQUFZLENBQUMsQ0FBQztRQVZ4QixZQUFZO1FBRVosWUFBWTtRQUVGLFdBQU0sR0FBb0MsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNwRCxjQUFTLEdBQW9DLElBQUksR0FBRyxFQUFFLENBQUM7UUFDdkQsY0FBUyxHQUFvRCxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBTTdFLElBQUksSUFBSSxLQUFLLEtBQUs7WUFDZCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO2dCQUNwQixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUE3QkQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFVLEVBQUUsSUFBVTtRQUNqQyxJQUFJLElBQUksS0FBSyxTQUFTLEVBQUU7WUFDcEIsT0FBTyxJQUFJLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNuQzthQUFNLElBQUksUUFBUSxLQUFLLE9BQU8sSUFBSSxFQUFFO1lBQ2pDLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzFCO1FBRUQsS0FBSyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLEtBQUssR0FBRyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDN0QsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztTQUM5QjtRQUVELEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElB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O0lBRUQ7O09BRUc7SUFDSCxHQUFHLENBQUMsR0FBTTtRQUNOLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBSTtRQUNBLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNO1FBQ0YsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ2hDLENBQUM7Q0FHSjtBQXpRRCxzQ0F5UUMiLCJmaWxlIjoiT2JzZXJ2YWJsZURhdGFUeXBlL09ic2VydmFibGVNYXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlVmFyaWFibGUgfSBmcm9tIFwiLi9PYnNlcnZhYmxlVmFyaWFibGVcIjtcclxuXHJcbi8qKlxyXG4gKiDlj6/op4Llr5/mlLnlj5hNYXBcclxuICovXHJcbmV4cG9ydCBjbGFzcyBPYnNlcnZhYmxlTWFwPEssIFY+IGV4dGVuZHMgT2JzZXJ2YWJsZVZhcmlhYmxlPE1hcDxLLCBWPj4ge1xyXG5cclxuICAgIC8vI3JlZ2lvbiDpnZnmgIHmlrnms5VcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWwhuS4gOS4quaVsOe7hOi9rOaNouaIkOWPr+inguWvn01hcO+8jOebuOW9k+S6jiBuZXcgT2JzZXJ2YWJsZU1hcCh2YWx1ZSlcclxuICAgICAqL1xyXG4gICAgc3RhdGljIG9ic2VydmU8SywgVj4odmFsdWU6IE9ic2VydmFibGVNYXA8SywgVj4gfCBNYXA8SywgVj4gfCBSZWFkb25seUFycmF5PFtLLCBWXT4pOiBPYnNlcnZhYmxlTWFwPEssIFY+O1xyXG4gICAgLyoqXHJcbiAgICAgKiDlsIblr7nosaHkuK3mjIflrprkvY3nva7nmoTkuIDkuKrmlbDnu4TovazmjaLmiJDlj6/op4Llr59NYXDvvIzot6/lvoTpgJrov4dgLmDliIblibJcclxuICAgICAqL1xyXG4gICAgc3RhdGljIG9ic2VydmUob2JqZWN0OiBvYmplY3QsIHBhdGg6IHN0cmluZyk6IHZvaWQ7XHJcbiAgICAvKipcclxuICAgICAqIOWwhuWvueixoeS4reaMh+WumuS9jee9rueahOS4gOS4quaVsOe7hOi9rOaNouaIkOWPr+inguWvn01hcFxyXG4gICAgICovXHJcbiAgICBzdGF0aWMgb2JzZXJ2ZShvYmplY3Q6IG9iamVjdCwgcGF0aDogc3RyaW5nW10pOiB2b2lkO1xyXG4gICAgc3RhdGljIG9ic2VydmUodmFsdWU6IGFueSwgcGF0aD86IGFueSk6IGFueSB7XHJcbiAgICAgICAgaWYgKHBhdGggPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IE9ic2VydmFibGVNYXAodmFsdWUpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoJ3N0cmluZycgPT09IHR5cGVvZiBwYXRoKSB7XHJcbiAgICAgICAgICAgIHBhdGggPSBwYXRoLnNwbGl0KCcuJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGxldCBpbmRleCA9IDAsIGVuZCA9IHBhdGgubGVuZ3RoIC0gMTsgaW5kZXggPCBlbmQ7IGluZGV4KyspIHtcclxuICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZVtwYXRoW2luZGV4XV07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB2YWx1ZVtwYXRoW3BhdGgubGVuZ3RoIC0gMV1dID0gbmV3IE9ic2VydmFibGVNYXAodmFsdWVbcGF0aFtwYXRoLmxlbmd0aCAtIDFdXSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8jZW5kcmVnaW9uXHJcblxyXG4gICAgLy8jcmVnaW9uIOWxnuaAp1xyXG5cclxuICAgIHByb3RlY3RlZCBfb25BZGQ6IFNldDwodmFsdWU6IFYsIGtleTogSykgPT4gdm9pZD4gPSBuZXcgU2V0KCk7XHJcbiAgICBwcm90ZWN0ZWQgX29uUmVtb3ZlOiBTZXQ8KHZhbHVlOiBWLCBrZXk6IEspID0+IHZvaWQ+ID0gbmV3IFNldCgpO1xyXG4gICAgcHJvdGVjdGVkIF9vblVwZGF0ZTogU2V0PChuZXdWYWx1ZTogViwgb2xkVmFsdWU6IFYsIGtleTogSykgPT4gdm9pZD4gPSBuZXcgU2V0KCk7XHJcbiAgICBwcm90ZWN0ZWQgX29uQmVmb3JlVXBkYXRlOiAoa2V5OiBLLCBuZXdWYWx1ZTogViwgb2xkVmFsdWU6IFYsIG1hcDogTWFwPEssIFY+KSA9PiBib29sZWFuIHwgdm9pZDtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcih2YWx1ZTogT2JzZXJ2YWJsZU1hcDxLLCBWPiB8IE1hcDxLLCBWPiB8IFJlYWRvbmx5QXJyYXk8W0ssIFZdPikge1xyXG4gICAgICAgIHN1cGVyKHZhbHVlIGFzIGFueSk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzICE9PSB2YWx1ZSlcclxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5fdmFsdWUgPSBuZXcgTWFwKHZhbHVlKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIE1hcOWFg+e0oOS4quaVsFxyXG4gICAgICovXHJcbiAgICBnZXQgc2l6ZSgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fdmFsdWUuc2l6ZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyNlbmRyZWdpb25cclxuXHJcbiAgICAvLyNyZWdpb24gdG9KU09OXHJcblxyXG4gICAgcHJvdGVjdGVkIHRvSlNPTigpOiBhbnkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNlcmlhbGl6YWJsZSA/IFsuLi50aGlzLl92YWx1ZV0gOiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgLy8jZW5kcmVnaW9uXHJcblxyXG4gICAgLy8jcmVnaW9uIOS6i+S7tue7keWumuaWueazlVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5b2T6K6+572u5YC855qE5pe25YCZ6Kem5Y+RXHJcbiAgICAgKi9cclxuICAgIG9uKGV2ZW50OiAnc2V0JywgY2FsbGJhY2s6IChuZXdWYWx1ZTogTWFwPEssIFY+LCBvbGRWYWx1ZTogTWFwPEssIFY+KSA9PiB2b2lkKTogdm9pZDtcclxuICAgIC8qKlxyXG4gICAgICog5Zyo5YC85Y+R55Sf5pS55Y+Y5LmL5YmN6Kem5Y+R77yM6L+U5Zuedm9pZOaIlnRydWXooajnpLrlkIzmhI/mm7TmlLnvvIzov5Tlm55mYWxzZeihqOekuumYu+atouabtOaUueOAguazqOaEj++8muivpeWbnuiwg+WPquWFgeiuuOiuvue9ruS4gOS4qu+8jOmHjeWkjeiuvue9ruWwhuimhuebluS5i+WJjeeahOWbnuiwg1xyXG4gICAgICovXHJcbiAgICBvbihldmVudDogJ2JlZm9yZVNldCcsIGNhbGxiYWNrOiAobmV3VmFsdWU6IE1hcDxLLCBWPiwgb2xkVmFsdWU6IE1hcDxLLCBWPiwgb01hcDogdGhpcykgPT4gYm9vbGVhbiB8IHZvaWQpOiB2b2lkO1xyXG4gICAgLyoqXHJcbiAgICAgKiDlvZPmm7TmlrBNYXDkuK3mn5DkuKrlhYPntKDnmoTlgLzml7bop6blj5FcclxuICAgICAqL1xyXG4gICAgb24oZXZlbnQ6ICd1cGRhdGUnLCBjYWxsYmFjazogKG5ld1ZhbHVlOiBWLCBvbGRWYWx1ZTogViwga2V5OiBLKSA9PiB2b2lkKTogdm9pZDtcclxuICAgIC8qKlxyXG4gICAgICog5Zyo5pu05pawTWFw5Lit5p+Q5Liq5YWD57Sg55qE5YC85LmL5YmN6Kem5Y+R77yM6L+U5Zuedm9pZOaIlnRydWXooajnpLrlkIzmhI/mm7TmlLnvvIzov5Tlm55mYWxzZeihqOekuumYu+atouabtOaUueOAglxyXG4gICAgICog5rOo5oSP77ya6K+l5Zue6LCD5Y+q5YWB6K646K6+572u5LiA5Liq77yM6YeN5aSN6K6+572u5bCG6KaG55uW5LmL5YmN55qE5Zue6LCD44CC5Zue6LCD5Lit55qE56ys5Zub5Liq5Y+C5pWwXCJtYXBcIiDmmK/ooqvljIXoo7nnmoRNYXDlr7nosaHvvIzkuI3mmK9PYnNlcnZhYmxlTWFwXHJcbiAgICAgKi9cclxuICAgIG9uKGV2ZW50OiAnYmVmb3JlVXBkYXRlJywgY2FsbGJhY2s6IChrZXk6IEssIG5ld1ZhbHVlOiBWLCBvbGRWYWx1ZTogViwgbWFwOiBNYXA8SywgVj4pID0+IGJvb2xlYW4gfCB2b2lkKTogdm9pZDtcclxuICAgIC8qKlxyXG4gICAgICog5b2T5ZCRTWFw5Lit5re75Yqg5YWD57Sg5pe26Kem5Y+RXHJcbiAgICAgKi9cclxuICAgIG9uKGV2ZW50OiAnYWRkJywgY2FsbGJhY2s6ICh2YWx1ZTogViwga2V5OiBLKSA9PiB2b2lkKTogdm9pZDtcclxuICAgIC8qKlxyXG4gICAgICog5b2T5Yig6ZmkTWFw5Lit5YWD57Sg5pe26Kem5Y+RXHJcbiAgICAgKi9cclxuICAgIG9uKGV2ZW50OiAncmVtb3ZlJywgY2FsbGJhY2s6ICh2YWx1ZTogViwga2V5OiBLKSA9PiB2b2lkKTogdm9pZDtcclxuICAgIG9uKGV2ZW50OiBhbnksIGNhbGxiYWNrOiBhbnkpOiBhbnkge1xyXG4gICAgICAgIHN3aXRjaCAoZXZlbnQpIHtcclxuICAgICAgICAgICAgY2FzZSAndXBkYXRlJzpcclxuICAgICAgICAgICAgICAgIHRoaXMuX29uVXBkYXRlLmFkZChjYWxsYmFjayk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgIGNhc2UgJ2JlZm9yZVVwZGF0ZSc6XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9vbkJlZm9yZVVwZGF0ZSA9IGNhbGxiYWNrO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICBjYXNlICdhZGQnOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5fb25BZGQuYWRkKGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgY2FzZSAncmVtb3ZlJzpcclxuICAgICAgICAgICAgICAgIHRoaXMuX29uUmVtb3ZlLmFkZChjYWxsYmFjayk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICBzdXBlci5vbihldmVudCwgY2FsbGJhY2spO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG9uY2UoZXZlbnQ6ICdzZXQnLCBjYWxsYmFjazogKG5ld1ZhbHVlOiBNYXA8SywgVj4sIG9sZFZhbHVlOiBNYXA8SywgVj4pID0+IHZvaWQpOiB2b2lkO1xyXG4gICAgb25jZShldmVudDogJ2JlZm9yZVNldCcsIGNhbGxiYWNrOiAobmV3VmFsdWU6IE1hcDxLLCBWPiwgb2xkVmFsdWU6IE1hcDxLLCBWPiwgb01hcDogdGhpcykgPT4gYm9vbGVhbiB8IHZvaWQpOiB2b2lkO1xyXG4gICAgb25jZShldmVudDogJ3VwZGF0ZScsIGNhbGxiYWNrOiAobmV3VmFsdWU6IFYsIG9sZFZhbHVlOiBWLCBrZXk6IEspID0+IHZvaWQpOiB2b2lkO1xyXG4gICAgb25jZShldmVudDogJ2JlZm9yZVVwZGF0ZScsIGNhbGxiYWNrOiAoa2V5OiBLLCBuZXdWYWx1ZTogViwgb2xkVmFsdWU6IFYsIG1hcDogTWFwPEssIFY+KSA9PiBib29sZWFuIHwgdm9pZCk6IHZvaWQ7XHJcbiAgICBvbmNlKGV2ZW50OiAnYWRkJywgY2FsbGJhY2s6ICh2YWx1ZTogViwga2V5OiBLKSA9PiB2b2lkKTogdm9pZDtcclxuICAgIG9uY2UoZXZlbnQ6ICdyZW1vdmUnLCBjYWxsYmFjazogKHZhbHVlOiBWLCBrZXk6IEspID0+IHZvaWQpOiB2b2lkO1xyXG4gICAgb25jZShldmVudDogYW55LCBjYWxsYmFjazogYW55KTogYW55IHtcclxuICAgICAgICBzdXBlci5vbmNlKGV2ZW50LCBjYWxsYmFjayk7XHJcbiAgICB9XHJcblxyXG4gICAgb2ZmKGV2ZW50OiAnc2V0JywgY2FsbGJhY2s/OiAobmV3VmFsdWU6IE1hcDxLLCBWPiwgb2xkVmFsdWU6IE1hcDxLLCBWPikgPT4gdm9pZCk6IHZvaWQ7XHJcbiAgICBvZmYoZXZlbnQ6ICdiZWZvcmVTZXQnLCBjYWxsYmFjaz86IChuZXdWYWx1ZTogTWFwPEssIFY+LCBvbGRWYWx1ZTogTWFwPEssIFY+LCBvTWFwOiB0aGlzKSA9PiBib29sZWFuIHwgdm9pZCk6IHZvaWQ7XHJcbiAgICBvZmYoZXZlbnQ6ICd1cGRhdGUnLCBjYWxsYmFjaz86IChuZXdWYWx1ZTogViwgb2xkVmFsdWU6IFYsIGtleTogSykgPT4gdm9pZCk6IHZvaWQ7XHJcbiAgICBvZmYoZXZlbnQ6ICdiZWZvcmVVcGRhdGUnLCBjYWxsYmFjaz86IChrZXk6IEssIG5ld1ZhbHVlOiBWLCBvbGRWYWx1ZTogViwgbWFwOiBNYXA8SywgVj4pID0+IGJvb2xlYW4gfCB2b2lkKTogdm9pZDtcclxuICAgIG9mZihldmVudDogJ2FkZCcsIGNhbGxiYWNrPzogKHZhbHVlOiBWLCBrZXk6IEspID0+IHZvaWQpOiB2b2lkO1xyXG4gICAgb2ZmKGV2ZW50OiAncmVtb3ZlJywgY2FsbGJhY2s/OiAodmFsdWU6IFYsIGtleTogSykgPT4gdm9pZCk6IHZvaWQ7XHJcbiAgICBvZmYoZXZlbnQ6IGFueSwgY2FsbGJhY2s6IGFueSk6IGFueSB7XHJcbiAgICAgICAgc3dpdGNoIChldmVudCkge1xyXG4gICAgICAgICAgICBjYXNlICd1cGRhdGUnOlxyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2sgPyB0aGlzLl9vblVwZGF0ZS5kZWxldGUoY2FsbGJhY2spIDogdGhpcy5fb25VcGRhdGUuY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgY2FzZSAnYmVmb3JlVXBkYXRlJzpcclxuICAgICAgICAgICAgICAgIHRoaXMuX29uQmVmb3JlVXBkYXRlID0gdW5kZWZpbmVkIGFzIGFueTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgY2FzZSAnYWRkJzpcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrID8gdGhpcy5fb25BZGQuZGVsZXRlKGNhbGxiYWNrKSA6IHRoaXMuX29uQWRkLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgIGNhc2UgJ3JlbW92ZSc6XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayA/IHRoaXMuX29uUmVtb3ZlLmRlbGV0ZShjYWxsYmFjaykgOiB0aGlzLl9vblJlbW92ZS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgc3VwZXIub2ZmKGV2ZW50LCBjYWxsYmFjayk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8jZW5kcmVnaW9uXHJcblxyXG4gICAgLy8jcmVnaW9uIE1hcOS/ruaUueaTjeS9nOaWueazlVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog56e76ZmkTWFw5a+56LGh5Lit55qE5omA5pyJ5YWD57Sg44CCXHJcbiAgICAgKi9cclxuICAgIGNsZWFyKCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLnJlYWRvbmx5KVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYOWwneivleS/ruaUueS4gOS4quWPquivu+eahCAke3RoaXMuY29uc3RydWN0b3IubmFtZX1gKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuX29uUmVtb3ZlLnNpemUgPiAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3ZhbHVlLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3ZhbHVlLmRlbGV0ZShrZXkpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fb25SZW1vdmUuZm9yRWFjaChjYWxsYmFjayA9PiBjYWxsYmFjayh2YWx1ZSwga2V5KSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICB0aGlzLl92YWx1ZS5jbGVhcigpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog55So5LqO56e76ZmkIE1hcCDlr7nosaHkuK3mjIflrprnmoTlhYPntKDjgIJcclxuICAgICAqL1xyXG4gICAgZGVsZXRlKGtleTogSyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICh0aGlzLnJlYWRvbmx5KVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYOWwneivleS/ruaUueS4gOS4quWPquivu+eahCAke3RoaXMuY29uc3RydWN0b3IubmFtZX1gKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuX29uUmVtb3ZlLnNpemUgPiAwKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl92YWx1ZS5oYXMoa2V5KSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl92YWx1ZS5nZXQoa2V5KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3ZhbHVlLmRlbGV0ZShrZXkpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fb25SZW1vdmUuZm9yRWFjaChjYWxsYmFjayA9PiBjYWxsYmFjayh2YWx1ZSBhcyBWLCBrZXkpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3ZhbHVlLmRlbGV0ZShrZXkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Li6TWFw5a+56LGh5re75Yqg5LiA5Liq5oyH5a6a6ZSu77yIa2V577yJ5ZKM5YC877yIdmFsdWXvvInnmoTmlrDlhYPntKDjgIJcclxuICAgICAqL1xyXG4gICAgc2V0KGtleTogSywgdmFsdWU6IFYpOiB0aGlzIHtcclxuICAgICAgICBpZiAodGhpcy5yZWFkb25seSlcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGDlsJ3or5Xkv67mlLnkuIDkuKrlj6ror7vnmoQgJHt0aGlzLmNvbnN0cnVjdG9yLm5hbWV9YCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLl92YWx1ZS5oYXMoa2V5KSkge1xyXG4gICAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXMuX3ZhbHVlLmdldChrZXkpIGFzIFY7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5fb25CZWZvcmVVcGRhdGUgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9vbkJlZm9yZVVwZGF0ZShrZXksIHZhbHVlLCBvbGRWYWx1ZSwgdGhpcy5fdmFsdWUpID09PSBmYWxzZSlcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcclxuXHJcbiAgICAgICAgICAgIHRoaXMuX3ZhbHVlLnNldChrZXksIHZhbHVlKTtcclxuICAgICAgICAgICAgdGhpcy5fb25VcGRhdGUuZm9yRWFjaChjYWxsYmFjayA9PiBjYWxsYmFjayh2YWx1ZSwgb2xkVmFsdWUsIGtleSkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3ZhbHVlLnNldChrZXksIHZhbHVlKTtcclxuICAgICAgICAgICAgdGhpcy5fb25BZGQuZm9yRWFjaChjYWxsYmFjayA9PiBjYWxsYmFjayh2YWx1ZSwga2V5KSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICAvLyNlbmRyZWdpb25cclxuXHJcbiAgICAvLyNyZWdpb24gTWFw6K+75Y+W5pON5L2c5pa55rOVXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDov5Tlm57kuIDkuKrmlrDnmoTljIXlkKsgW2tleSwgdmFsdWVdIOWvueeahCBJdGVyYXRvciDlr7nosaHvvIzov5Tlm57nmoTov63ku6PlmajnmoTov63ku6Ppobrluo/kuI4gTWFwIOWvueixoeeahOaPkuWFpemhuuW6j+ebuOWQjOOAglxyXG4gICAgICovXHJcbiAgICBlbnRyaWVzKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl92YWx1ZS5lbnRyaWVzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDku6Xmj5LlhaXpobrluo/lr7kgTWFwIOWvueixoeS4reeahOavj+S4gOS4qumUruWAvOWvueaJp+ihjOS4gOasoeWPguaVsOS4reaPkOS+m+eahOWbnuiwg+WHveaVsOOAglxyXG4gICAgICovXHJcbiAgICBmb3JFYWNoKGNhbGxiYWNrZm46ICh2YWx1ZTogViwga2V5OiBLLCBtYXA6IE1hcDxLLCBWPikgPT4gdm9pZCwgdGhpc0FyZz86IGFueSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuX3ZhbHVlLmZvckVhY2goY2FsbGJhY2tmbiwgdGhpc0FyZyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnlKjmnaXojrflj5bkuIDkuKogTWFwIOWvueixoeS4reaMh+WumueahOWFg+e0oOOAglxyXG4gICAgICovXHJcbiAgICBnZXQoa2V5OiBLKTogViB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ZhbHVlLmdldChrZXkpIGFzIFY7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDov5Tlm57kuIDkuKpib29s5YC877yM55So5p2l6KGo5piObWFwIOS4reaYr+WQpuWtmOWcqOaMh+WumuWFg+e0oFxyXG4gICAgICovXHJcbiAgICBoYXMoa2V5OiBLKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ZhbHVlLmhhcyhrZXkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6L+U5Zue5LiA5Liq5paw55qEIEl0ZXJhdG9yIOWvueixoeOAguWug+WMheWQq+aMieeFp+mhuuW6j+aPkuWFpU1hcOWvueixoeS4reavj+S4quWFg+e0oOeahGtleeWAvOOAglxyXG4gICAgICovXHJcbiAgICBrZXlzKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl92YWx1ZS5rZXlzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDov5Tlm57kuIDkuKrmlrDnmoRJdGVyYXRvcuWvueixoeOAguWug+WMheWQq+aMiemhuuW6j+aPkuWFpU1hcOWvueixoeS4reavj+S4quWFg+e0oOeahHZhbHVl5YC844CCXHJcbiAgICAgKi9cclxuICAgIHZhbHVlcygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fdmFsdWUudmFsdWVzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8jZW5kcmVnaW9uXHJcbn0iXX0=
